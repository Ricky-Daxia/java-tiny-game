<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SnakeGameScreen.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">j05</a> &gt; <a href="index.source.html" class="el_package">game.screen</a> &gt; <span class="el_source">SnakeGameScreen.java</span></div><h1>SnakeGameScreen.java</h1><pre class="source lang-java linenums">package game.screen;

import java.awt.Color;
import java.awt.event.KeyEvent;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.concurrent.ScheduledThreadPoolExecutor;
import java.util.concurrent.atomic.AtomicBoolean;

import game.asciiPanel.AsciiPanel;
import game.world.BossAI;
import game.world.Creature;
import game.world.CreatureFactory;
import game.world.SnakeAI;
import game.world.World;
import game.world.WorldBuilder;

public class SnakeGameScreen implements Screen, Serializable {

    private static final int WORLD_WIDTH = 40;
    private static final int WORLD_HEIGHT = 40;

    private static final int SCREEN_WIDTH = 40;
    private static final int SCREEN_HEIGHT = 40;

    // private static final int LEFT_KEY = 37;
    // private static final int RIGHT_KEY = 39;
    // private static final int UP_KEY = 38;
    // private static final int DOWN_KEY = 40;

    // private static final int DELAY_TIME = 200;

    // private int direction = 1;

    private HashMap&lt;Integer, Creature&gt; snakes;
    private List&lt;Creature&gt; bossList;
    private CreatureFactory factory;

    // private List&lt;String&gt; messages;
    // private List&lt;String&gt; oldMessages;

    private World world;

    public SnakeGameScreen() {
<span class="fc" id="L47">        super();</span>

<span class="fc" id="L49">        createWorld();</span>
        // this.messages = new ArrayList&lt;String&gt;();
        // this.oldMessages = new ArrayList&lt;String&gt;();

<span class="fc" id="L53">        CreatureFactory creatureFactory = new CreatureFactory(this.world);</span>
<span class="fc" id="L54">        this.factory = creatureFactory;</span>
<span class="fc" id="L55">        this.bossList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L56">        createCreatures(creatureFactory);</span>
<span class="fc" id="L57">    }</span>

    private void createCreatures(CreatureFactory creatureFactory) {
        // this.snake = creatureFactory.newSnake(this.messages);
<span class="fc" id="L61">        this.snakes = new HashMap&lt;&gt;();</span>
        // snakes.put(0, creatureFactory.newSnake(this.messages)); 

<span class="fc bfc" id="L64" title="All 2 branches covered.">        for (int i = 0; i &lt; 5; i++) {</span>
<span class="fc" id="L65">            creatureFactory.newBean();</span>
        }
<span class="fc bfc" id="L67" title="All 2 branches covered.">        for (int i = 0; i &lt; 2; i++) {</span>
<span class="fc" id="L68">            this.bossList.add(creatureFactory.newBoss(creatureFactory));</span>
        }
<span class="fc" id="L70">    }</span>

    public void registerSnake(int id) {
<span class="fc" id="L73">        this.snakes.put(id, this.factory.newSnake());</span>
<span class="fc" id="L74">    }</span>

    private void createWorld() {
<span class="fc" id="L77">        world = new WorldBuilder(WORLD_WIDTH, WORLD_HEIGHT).makeRectangle().build();</span>
<span class="fc" id="L78">    }</span>

    @Override
    public void displayOutput(AsciiPanel terminal, int id) {

        // Terrain and creatures
<span class="fc" id="L84">        displayTiles(terminal, getScrollX(), getScrollY());</span>
        // Player
        //((GlyphDelegate) snake.getAI()).printGlyph(terminal, getScrollX(), getScrollY());
        // Stats
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (!snakes.containsKey(id)) {</span>
            //System.out.println(&quot;snake with id &quot; + id + &quot; not exist&quot;);
<span class="fc" id="L90">            return;</span>
        }        
<span class="fc" id="L92">        String stats = String.format(&quot;%3d/%3d hp&quot;, snakes.get(id).hp(), snakes.get(id).maxHP()); // use id</span>
<span class="fc" id="L93">        terminal.write(stats, 1, 0);</span>
        // Messages
        // displayMessages(terminal, null);
<span class="fc" id="L96">    }</span>

    private void displayTiles(AsciiPanel terminal, int left, int top) {
        // Show terrain
<span class="fc bfc" id="L100" title="All 2 branches covered.">        for (int x = 0; x &lt; SCREEN_WIDTH; x++) {</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">            for (int y = 0; y &lt; SCREEN_HEIGHT; y++) {</span>
<span class="fc" id="L102">                int wx = x + left;</span>
<span class="fc" id="L103">                int wy = y + top;</span>

                // if (snake.canSee(wx, wy)) {
                //     terminal.write(world.glyph(wx, wy), x, y, world.color(wx, wy));
                // } else {
                //     terminal.write(world.glyph(wx, wy), x, y, Color.DARK_GRAY);
                // }
<span class="fc" id="L110">                terminal.write(world.glyph(wx, wy), x, y, Color.DARK_GRAY);</span>
            }
        }
        // Show creatures
        // world.lock();
<span class="fc bfc" id="L115" title="All 2 branches covered.">        for (Creature creature : world.getCreatures()) {</span>
<span class="pc bpc" id="L116" title="3 of 6 branches missed.">            if (creature.x() &gt;= left &amp;&amp; creature.x() &lt; left + SCREEN_WIDTH &amp;&amp; creature.y() &gt;= top</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">                    &amp;&amp; creature.y() &lt; top + SCREEN_HEIGHT) {</span>
                // if (snake.canSee(creature.x(), creature.y())) {
                // if (creature.getAI() instanceof GlyphDelegate) {
                //     ((GlyphDelegate) creature.getAI()).printGlyph(terminal, left, top);
                // } else {
<span class="fc" id="L122">                    terminal.write(creature.glyph(), creature.x() - left, creature.y() - top, creature.color());</span>
                // }
                // }
            }
<span class="fc" id="L126">        }</span>
        // world.unlock();
        // Creatures can choose their next action now
        // world.update();
        // update();
<span class="fc" id="L131">    }</span>

    public void update() {
        //System.out.println(&quot;snakes.size() = &quot; + snakes.size());
<span class="fc" id="L135">        synchronized (snakes) {</span>
<span class="fc" id="L136">            int[] manPos = new int[snakes.size()];</span>
<span class="fc" id="L137">            int pos = 0;</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">            for (Creature creature: snakes.values()) {</span>
<span class="fc" id="L139">                manPos[pos] = (creature.x() &lt;&lt; 10) | creature.y();</span>
<span class="fc" id="L140">                pos++;</span>
<span class="fc" id="L141">            }</span>
<span class="fc" id="L142">            world.setManPos(manPos);      </span>
<span class="fc" id="L143">        }</span>
<span class="fc" id="L144">        world.update();</span>
<span class="fc" id="L145">        synchronized (this.bossList) {</span>
<span class="fc" id="L146">            int[] x = new int[this.bossList.size()];</span>
<span class="fc" id="L147">            int[] y = new int[this.bossList.size()];</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">            for (int k = 0; k &lt; this.bossList.size(); k++) {</span>
<span class="fc" id="L149">                x[k] = this.bossList.get(k).x();</span>
<span class="fc" id="L150">                y[k] = this.bossList.get(k).y();</span>
            }
<span class="fc" id="L152">            world.setPolluted(x, y);</span>
<span class="fc" id="L153">        }</span>
<span class="fc" id="L154">    }</span>

    // private void displayMessages(AsciiPanel terminal, List&lt;String&gt; messages) {
    //     int top = SCREEN_HEIGHT - messages.size();
    //     for (int i = 0; i &lt; messages.size(); i++) {
    //         terminal.write(messages.get(i), 1, top + i + 1);
    //     }
    //     this.oldMessages.addAll(messages);
    //     messages.clear();
    // }

    public int getScrollX() {
<span class="fc" id="L166">        return 0; //Math.max(0, Math.min(snake.x() - SCREEN_WIDTH / 2, world.width() - SCREEN_WIDTH));</span>
    }

    public int getScrollY() {
<span class="fc" id="L170">        return 0; //Math.max(0, Math.min(snake.y() - SCREEN_HEIGHT / 2, world.height() - SCREEN_HEIGHT));</span>
    }

    @Override
    public Screen respondToUserInput(KeyEvent key, int id) {

        // switch (key.getKeyCode()) {
        // case LEFT_KEY:
        // direction = snake.MOVE_LEFT;
        // break;
        // case RIGHT_KEY:
        // direction = snake.MOVE_RIGHT;
        // break;
        // case UP_KEY:
        // direction = snake.MOVE_UP;
        // break;
        // case DOWN_KEY:
        // direction = snake.MOVE_DOWN;
        // break;
        // }

<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        if (this.snakes.get(id).hp() &lt; 0) {</span>
            //this.factory.getExecutor().shutdown();
<span class="nc" id="L193">            return new LoseScreen();</span>
        }
<span class="fc" id="L195">        boolean ok = true;</span>
<span class="fc" id="L196">        List&lt;Creature&gt; del = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">        for (Creature boss: this.bossList) {</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">            if (boss.hp() &lt; 1) {</span>
<span class="nc" id="L199">                del.add(boss);</span>
            } else {
<span class="fc" id="L201">                ok = false;</span>
            }
<span class="fc" id="L203">        }</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        for (Creature boss: del) {</span>
<span class="nc" id="L205">            this.bossList.remove(boss);</span>
<span class="nc" id="L206">        }</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        if (ok) {</span>
            //this.factory.getExecutor().shutdown();
<span class="nc" id="L209">            return new WinScreen();</span>
        }

<span class="pc bpc" id="L212" title="8 of 9 branches missed.">        switch (key.getKeyCode()) {</span>
            case KeyEvent.VK_LEFT:
<span class="nc" id="L214">                snakes.get(id).moveBy(-1, 0);</span>
<span class="nc" id="L215">                break;</span>
            case KeyEvent.VK_RIGHT:
<span class="nc" id="L217">                snakes.get(id).moveBy(1, 0);</span>
<span class="nc" id="L218">                break;</span>
            case KeyEvent.VK_UP:
<span class="nc" id="L220">                snakes.get(id).moveBy(0, -1);</span>
<span class="nc" id="L221">                break;</span>
            case KeyEvent.VK_DOWN:
<span class="nc" id="L223">                snakes.get(id).moveBy(0, 1);</span>
<span class="nc" id="L224">                break;</span>
            case KeyEvent.VK_A:
<span class="nc" id="L226">                factory.newBullet(snakes.get(id).x(), snakes.get(id).y(), -1, 0);</span>
<span class="nc" id="L227">                break;</span>
            case KeyEvent.VK_D:
<span class="nc" id="L229">                factory.newBullet(snakes.get(id).x(), snakes.get(id).y(), 1, 0);</span>
<span class="nc" id="L230">                break;</span>
            case KeyEvent.VK_W:
<span class="nc" id="L232">                factory.newBullet(snakes.get(id).x(), snakes.get(id).y(), 0, -1);</span>
<span class="nc" id="L233">                break;</span>
            case KeyEvent.VK_S:
<span class="nc" id="L235">                factory.newBullet(snakes.get(id).x(), snakes.get(id).y(), 0, 1);</span>
                break;
        }
<span class="fc" id="L238">        world.update();</span>

<span class="fc" id="L240">        return this;</span>
    }

    @Override
    public Screen respondToUserInput(int e, int id) {

<span class="pc bpc" id="L246" title="1 of 2 branches missed.">        if (this.snakes.get(id).hp() &lt; 0) {</span>
            //this.factory.getExecutor().shutdown();
<span class="nc" id="L248">            this.snakes.remove(id);</span>
<span class="nc" id="L249">            return new LoseScreen();</span>
        }
<span class="fc" id="L251">        boolean ok = true;</span>
<span class="fc" id="L252">        List&lt;Creature&gt; del = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">        for (Creature boss: this.bossList) {</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">            if (boss.hp() &lt; 1) {</span>
<span class="nc" id="L255">                del.add(boss);</span>
            } else {
<span class="fc" id="L257">                ok = false;</span>
            }
<span class="fc" id="L259">        }</span>
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">        for (Creature boss: del) {</span>
<span class="nc" id="L261">            this.bossList.remove(boss);</span>
<span class="nc" id="L262">        }</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">        if (ok) {</span>
            //this.factory.getExecutor().shutdown();
<span class="nc" id="L265">            return new WinScreen();</span>
        }

<span class="pc bpc" id="L268" title="1 of 9 branches missed.">        switch (e) {</span>
            case KeyEvent.VK_LEFT:
<span class="fc" id="L270">                snakes.get(id).moveBy(-1, 0);</span>
<span class="fc" id="L271">                break;</span>
            case KeyEvent.VK_RIGHT:
<span class="fc" id="L273">                snakes.get(id).moveBy(1, 0);</span>
<span class="fc" id="L274">                break;</span>
            case KeyEvent.VK_UP:
<span class="fc" id="L276">                snakes.get(id).moveBy(0, -1);</span>
<span class="fc" id="L277">                break;</span>
            case KeyEvent.VK_DOWN:
<span class="fc" id="L279">                snakes.get(id).moveBy(0, 1);</span>
<span class="fc" id="L280">                break;</span>
            case KeyEvent.VK_A:
<span class="fc" id="L282">                factory.newBullet(snakes.get(id).x(), snakes.get(id).y(), -1, 0);</span>
<span class="fc" id="L283">                break;</span>
            case KeyEvent.VK_D:
<span class="fc" id="L285">                factory.newBullet(snakes.get(id).x(), snakes.get(id).y(), 1, 0);</span>
<span class="fc" id="L286">                break;</span>
            case KeyEvent.VK_W:
<span class="fc" id="L288">                factory.newBullet(snakes.get(id).x(), snakes.get(id).y(), 0, -1);</span>
<span class="fc" id="L289">                break;</span>
            case KeyEvent.VK_S:
<span class="fc" id="L291">                factory.newBullet(snakes.get(id).x(), snakes.get(id).y(), 0, 1);</span>
                break;
        }
<span class="fc" id="L294">        world.update();</span>
<span class="fc" id="L295">        return this;</span>
    }

    // sync with record
    public void synchronize() {
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">        if (world.occupied == null) {</span>
<span class="nc" id="L301">            world.occupied = new AtomicBoolean[world.width()][world.height()];</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">            for (int i = 0; i &lt; world.width(); i++) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">                for (int j = 0; j &lt; world.height(); j++) {</span>
<span class="nc" id="L304">                    world.occupied[i][j] = new AtomicBoolean();</span>
                }
            }
<span class="nc bnc" id="L307" title="All 2 branches missed.">            for (Creature creature: world.getCreatures()) {</span>
<span class="nc" id="L308">                int x = creature.x(), y = creature.y();</span>
<span class="nc" id="L309">                world.occupied[x][y].compareAndSet(false, true);</span>
<span class="nc" id="L310">            }</span>
        }
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">        if (this.factory.emptyExecutor()) {</span>
<span class="nc" id="L313">            this.factory.setExecutor(new ScheduledThreadPoolExecutor(20));</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">            for (Creature snake: this.snakes.values()) {</span>
<span class="nc" id="L315">                this.factory.setSnakeTask((SnakeAI) snake.getAI());</span>
<span class="nc" id="L316">            }            </span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">            for (Creature boss: this.bossList) {</span>
<span class="nc" id="L318">                this.factory.setBossTask((BossAI) boss.getAI());</span>
<span class="nc" id="L319">            }</span>
        }
<span class="fc" id="L321">    }</span>

    public void removeSnake(int id) {
<span class="fc" id="L324">        Creature snake = snakes.get(id);</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">        if (snake != null) {</span>
<span class="fc" id="L326">            snake.modifyHP(-snake.maxHP() - 100);</span>
        }
<span class="fc" id="L328">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>