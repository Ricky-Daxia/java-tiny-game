<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Client.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">j05</a> &gt; <a href="index.source.html" class="el_package">game</a> &gt; <span class="el_source">Client.java</span></div><h1>Client.java</h1><pre class="source lang-java linenums">package game;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.io.ByteArrayInputStream;
import java.io.ObjectInputStream;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.SocketChannel;
import java.util.Iterator;

import javax.swing.JFrame;

import game.asciiPanel.AsciiFont;
import game.asciiPanel.AsciiPanel;
import game.screen.Screen;

public class Client extends JFrame implements KeyListener {

    private AsciiPanel terminal;
    public Screen screen;

    public Selector selector;
    public SocketChannel client;

    public int id;
    public long cnt;

    public Client() {
<span class="fc" id="L31">        super();</span>
<span class="fc" id="L32">        terminal = new AsciiPanel(40, 40, AsciiFont.gold);</span>
<span class="fc" id="L33">        add(terminal);</span>
<span class="fc" id="L34">        pack();</span>
<span class="fc" id="L35">        addKeyListener(this);</span>
<span class="fc" id="L36">        id = 0;</span>
<span class="fc" id="L37">        cnt = 0;</span>
<span class="fc" id="L38">    }</span>

    @Override 
    public void repaint() {
<span class="fc" id="L42">        terminal.clear();</span>
<span class="nc" id="L43">        screen.displayOutput(terminal, id);</span>
<span class="nc" id="L44">        super.repaint();</span>
<span class="nc" id="L45">    }</span>

    @Override
    public void keyPressed(KeyEvent e) {
        //System.out.println(&quot;key pressed&quot;);
<span class="fc" id="L50">        ByteBuffer buffer = ByteBuffer.allocate(Integer.BYTES);</span>
<span class="fc" id="L51">        buffer.putInt(e.getKeyCode());</span>
<span class="fc" id="L52">        buffer.flip();</span>
        try {
<span class="nc" id="L54">            client.write(buffer);</span>
<span class="fc" id="L55">        } catch (Exception exp) {</span>
<span class="fc" id="L56">            exp.printStackTrace();</span>
<span class="nc" id="L57">        }</span>
<span class="fc" id="L58">        buffer.clear();</span>
<span class="fc" id="L59">    }</span>

    @Override
    public void keyReleased(KeyEvent e) {

<span class="fc" id="L64">    }</span>

    @Override
    public void keyTyped(KeyEvent e) {

<span class="fc" id="L69">    }</span>

    public static void main(String[] args) {
<span class="fc" id="L72">        Client app = new Client();</span>
        try {
<span class="fc" id="L74">            app.selector = Selector.open();</span>
<span class="fc" id="L75">            InetSocketAddress hostAddress = new InetSocketAddress(&quot;localhost&quot;, 9093);</span>
<span class="nc" id="L76">            app.client = SocketChannel.open(hostAddress);</span>
<span class="nc" id="L77">            app.client.configureBlocking(false);</span>
<span class="nc" id="L78">            app.client.register(app.selector, SelectionKey.OP_READ);</span>
<span class="nc" id="L79">            app.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span>
<span class="nc" id="L80">            app.setVisible(true);</span>

<span class="nc" id="L82">            System.out.println(&quot;Client... started&quot;);     </span>
            
            // Thread clientThread = new Thread(new Runnable() {
            //     @Override
            //     public void run() {
            //         try {
            //             while (true) {
            //                 int count = selector.select();
            //                 System.out.println(count);
            //                 if (count &gt; 0) {
            //                     Iterator&lt;SelectionKey&gt; iterator =  selector.selectedKeys().iterator();
            //                     while (iterator.hasNext()) {
            //                         SelectionKey selectionKey = iterator.next();
            //                         if (selectionKey.isReadable()) {
            //                             SocketChannel channel = (SocketChannel) selectionKey.channel();
            //                             ByteBuffer byteBuffer = ByteBuffer.allocate(1024);
            //                             channel.read(byteBuffer);
            //                             System.out.println(new String(byteBuffer.array()));
            //                         }
            //                         iterator.remove();
            //                     }
            //                 }
            //             }   
            //         } catch (Exception e) {
            //             e.printStackTrace();
            //         }             
            //     }
            // });
            // clientThread.setDaemon(false);
            // clientThread.start();
            
            try {
                while (true) {
<span class="nc" id="L115">                    int count = app.selector.select();</span>
                    //System.out.println(count);
<span class="nc bnc" id="L117" title="All 2 branches missed.">                    if (count &gt; 0) {</span>
<span class="nc" id="L118">                        Iterator&lt;SelectionKey&gt; iterator =  app.selector.selectedKeys().iterator();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                        while (iterator.hasNext()) {</span>
<span class="nc" id="L120">                            SelectionKey selectionKey = iterator.next();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                            if (selectionKey.isReadable()) {</span>
<span class="nc" id="L122">                                SocketChannel channel = (SocketChannel) selectionKey.channel();</span>
<span class="nc" id="L123">                                ByteBuffer byteBuffer = ByteBuffer.allocate(100000);</span>
<span class="nc" id="L124">                                int length = channel.read(byteBuffer);</span>
                                //System.out.println(length);
<span class="nc" id="L126">                                byte[] bufferArray = byteBuffer.array();</span>
<span class="nc" id="L127">                                ByteArrayInputStream bis = new ByteArrayInputStream(bufferArray);</span>
<span class="nc" id="L128">                                ObjectInputStream ois = new ObjectInputStream(bis);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                                if (app.cnt == 0) {</span>
<span class="nc" id="L130">                                    app.id = (int) ois.readObject();</span>
<span class="nc" id="L131">                                    app.cnt++;</span>
                                    //System.out.println(length + &quot; id= &quot; + app.id);
                                } else {
                                    try {
<span class="nc" id="L135">                                        app.screen = (Screen) ois.readObject();</span>
<span class="nc" id="L136">                                        app.repaint();</span>
<span class="nc" id="L137">                                    } catch (Exception e) {</span>
<span class="nc" id="L138">                                        System.out.println(&quot;decode screen failed&quot;);</span>
                                    } finally {
<span class="nc" id="L140">                                        ois.close();</span>
                                    }                                    
                                }
                            }
<span class="nc" id="L144">                            iterator.remove();</span>
<span class="nc" id="L145">                        }</span>
                    }
<span class="nc" id="L147">                }   </span>
<span class="nc" id="L148">            } catch (Exception e) {</span>
<span class="nc" id="L149">                e.printStackTrace();</span>
            }             
<span class="fc" id="L151">        } catch (Exception e) {</span>
<span class="fc" id="L152">            e.printStackTrace();</span>
<span class="nc" id="L153">        }</span>

<span class="fc" id="L155">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>